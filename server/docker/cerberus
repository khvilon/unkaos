FROM node:23-alpine

WORKDIR /app

# Копируем common и устанавливаем его зависимости
COPY ./server/common ./server/common
WORKDIR /app/server/common
RUN yarn install

# Копируем сначала только файлы для установки зависимостей cerberus
WORKDIR /app
COPY ./server/cerberus/package.json ./cerberus/
WORKDIR /app/cerberus
RUN yarn install

# Устанавливаем pino-gelf глобально
RUN npm install -g pino-gelf

# Затем копируем файлы сервиса
COPY ./server/cerberus .

USER node

# Запускаем сервис и пайплайним логи через pino-gelf
CMD npx ts-node index.ts | pino-gelf log -h graylog -p 12201